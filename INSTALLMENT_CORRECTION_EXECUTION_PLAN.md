# 🛠️ 分納金額修正実行プラン

**実行日**: 2025-09-14
**目的**: 過剰分納問題の完全解決
**対象**: 総過剰額 ¥8,570,782 の修正

## 📊 現在の状況

### 確認された問題
- **過剰分納発注書**: 20件 (確認範囲)
- **総過剰額**: ¥8,570,782
- **主要パターン**: 税込/税抜問題 (1.1倍の過剰)

### 具体例
- PO250913010: 過剰額¥3,906,000 (発注額¥6,720,000)
- PO250912003: 過剰額¥1,710,000 (発注額¥1,425,000)
- PO250911015: 過剰額¥1,702,800 (発注額¥1,419,000)

## 🚀 実行手順

### Phase 1: 自動修正実行

**ブラウザコンソールで実行**:
```javascript
// 分納修正を自動実行
window.executeInstallmentCorrection()
```

**実行内容**:
1. **現状確認**: 問題のある発注書の特定
2. **税込調整**: 1.08-1.12倍の過剰分納を自動修正
3. **結果確認**: 修正後の整合性チェック

### Phase 2: 修正状況確認

```javascript
// 修正結果の詳細確認
window.checkCorrectionStatus()
```

**確認項目**:
- 完全一致した発注書数
- 軽微な差額の発注書数
- 未解決の問題数
- 全体の健全性率

## 🛡️ 安全対策

### 自動バックアップ
- **実行前**: 現在の状態を自動確認
- **段階的実行**: 一度に全て修正せず段階的に実行
- **エラーハンドリング**: 問題が発生した場合は即座に停止

### 復旧準備
- **手動SQL**: `scripts/safe_installment_correction.sql` に復旧用SQL完備
- **バックアップテーブル**: 修正前状態を保持
- **ロールバック**: 必要に応じて即座に復旧可能

## 📈 期待される結果

### 修正目標
- **完全解決**: 80%以上の過剰分納問題を自動解決
- **残存問題**: 複雑なケースは個別対応
- **整合性**: システム全体の整合性を回復

### 成功指標
- **解決率**: 80%以上
- **残存過剰額**: ¥2,000,000以下に削減
- **健全性**: 90%以上の発注書で正常な分納状態

## ⚠️ 注意事項

### 実行前の確認
1. **開発環境での実行**: 本番データですが安全な修正
2. **段階的実行**: 一度に全て修正せず確認しながら実行
3. **結果の検証**: 各段階で結果を必ず確認

### 実行後の対応
1. **整合性チェック**: 修正後の完全性確認
2. **業務影響確認**: 実際の分納処理への影響チェック
3. **ドキュメント更新**: 修正内容の記録

## 🎯 実行コマンド一覧

```javascript
// === 分納修正実行 ===
window.executeInstallmentCorrection()

// === 修正状況確認 ===
window.checkCorrectionStatus()

// === 基本データ分析 (必要に応じて) ===
window.runDataAnalysis()

// === 詳細整合性チェック (必要に応じて) ===
window.checkInstallmentIntegrity()
```

## 📋 次のステップ

1. **Phase 1実行**: `executeInstallmentCorrection()` で自動修正
2. **結果確認**: 修正率と残存問題を確認
3. **追加対応**: 必要に応じて個別問題の手動対応
4. **最終検証**: システム全体の整合性確認
5. **完了報告**: 修正結果の文書化

---

**重要**: 実行前に必ずバックアップが作成されていることを確認してください。問題が発生した場合は即座に停止し、復旧手順を実行してください。