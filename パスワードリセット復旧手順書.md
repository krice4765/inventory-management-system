# パスワードリセット機能復旧 - 詳細実行手順書

## 🎯 実行概要
- **目的**: Supabase SMTP設定によるパスワードリセット機能の完全復旧
- **所要時間**: 約30-45分
- **前提条件**: Supabase Dashboardへの管理者アクセス権

## 📋 Step 1: Supabase SMTP設定構成 [CRITICAL]

### 1.1 Supabase Dashboard アクセス
```
1. https://supabase.com/dashboard にアクセス
2. プロジェクトを選択
3. Authentication → Emails → SMTP Settings に移動
```

### 1.2 カスタムSMTP有効化
```
1. 「Set up custom SMTP server」ボタンをクリック
2. 「Enable Custom SMTP」スイッチを ON に設定
3. 以下の設定オプションから1つを選択
```

### 1.3 SMTP設定オプション

#### オプションA: Gmail SMTP (開発環境推奨)
```
SMTP Host: smtp.gmail.com
SMTP Port: 587
SMTP User: [あなたのGmailアドレス]
SMTP Pass: [Gmailアプリパスワード]
```

**Gmailアプリパスワード作成手順**:
1. Googleアカウント設定 → セキュリティ
2. 2段階認証を有効化
3. アプリパスワードを生成
4. 生成されたパスワードを使用

#### オプションB: SendGrid (本番環境推奨)
```
SMTP Host: smtp.sendgrid.net
SMTP Port: 587
SMTP User: apikey
SMTP Pass: [SendGrid API Key]
```

**SendGrid設定手順**:
1. SendGridアカウント作成
2. API Keys → Create API Key
3. Full Access権限で作成
4. 生成されたAPI Keyを使用

### 1.4 設定保存と確認
```
1. 「Save」ボタンをクリック
2. 設定が正常に保存されることを確認
3. 接続テストが可能な場合は実行
```

## 📋 Step 2: SMTP設定動作テスト

### 2.1 基本動作確認
```
1. アプリケーションのログイン画面にアクセス
2. 「パスワードを忘れた場合」をクリック
3. テスト用メールアドレスを入力: test567@example.com
4. 送信ボタンをクリック
```

### 2.2 エラーログ確認
```
1. ブラウザの開発者ツール(F12)を開く
2. Console タブでエラーメッセージを確認
3. Network タブでAPI レスポンスを確認
4. "Email address is invalid" エラーが出ないことを確認
```

### 2.3 メール受信確認
```
1. test567@example.com の受信トレイを確認
2. パスワードリセットメールが届くことを確認
3. メール内のリンクが正常に動作することを確認
```

## 📋 Step 3: URL Configuration 確認・調整

### 3.1 URL設定確認
```
場所: Supabase Dashboard → Authentication → URL Configuration

確認項目:
- Site URL: http://localhost:5173 (開発環境)
- Password reset redirect URL: http://localhost:5173/reset-password
```

### 3.2 本番環境URL設定
```
本番環境デプロイ時の設定:
- Site URL: https://your-domain.com
- Password reset redirect URL: https://your-domain.com/reset-password
```

### 3.3 リダイレクト設定テスト
```
1. パスワードリセットメールのリンクをクリック
2. 正しいページにリダイレクトされることを確認
3. トークンが適切に渡されることを確認
```

## 📋 Step 4: パスワードリセット機能総合テスト

### 4.1 全ユーザーテスト
```
テスト対象ユーザー:
1. test567@example.com
2. krice4765104@gmail.com
3. dev@inventory.test

各ユーザーで以下を実行:
1. パスワードリセット要求
2. メール受信確認
3. パスワード変更実行
4. 新パスワードでログイン確認
```

### 4.2 エラーハンドリングテスト
```
1. 存在しないメールアドレスでテスト
2. 不正な形式のメールアドレスでテスト
3. レート制限テスト（連続送信）
4. 期限切れトークンのテスト
```

### 4.3 管理者通知システム確認
```
1. 管理者に通知が届くことを確認
2. system_notifications テーブルに記録されることを確認
3. 通知内容が適切であることを確認
```

## 📋 Step 5: メール送信ログ設定と監視体制構築

### 5.1 送信ログ設定
```
場所: Supabase Dashboard → Logs → Auth Logs

設定項目:
1. メール送信成功/失敗ログの有効化
2. SMTP接続エラーログの記録
3. レート制限到達時のアラート設定
```

### 5.2 監視体制構築
```
1. 日次メール送信状況の確認
2. SMTP接続状態の定期チェック
3. エラー率が閾値を超えた場合のアラート
4. 週次でのSMTP設定確認
```

### 5.3 運用手順書作成
```
作成項目:
1. 日常運用チェックリスト
2. 障害発生時の対応手順
3. SMTP認証情報の更新手順
4. ユーザーサポート対応マニュアル
```

## ✅ 完了チェックリスト

### Phase 1: SMTP設定
- [ ] カスタムSMTP設定が有効化済み
- [ ] 適切なSMTPプロバイダー設定完了
- [ ] 接続テスト成功確認

### Phase 2: 機能テスト
- [ ] 全テストユーザーでパスワードリセット成功
- [ ] エラーハンドリング正常動作確認
- [ ] リダイレクト設定動作確認

### Phase 3: 運用体制
- [ ] ログ設定と監視体制構築完了
- [ ] 運用手順書作成完了
- [ ] チーム内での情報共有完了

## 🚨 トラブルシューティング

### よくある問題と解決策

#### 1. SMTP接続エラー
```
症状: "SMTP connection failed"
解決策:
1. SMTP認証情報の再確認
2. ファイアウォール設定確認
3. SMTPプロバイダーの状態確認
```

#### 2. メールが届かない
```
症状: エラーは出ないがメールが届かない
解決策:
1. スパムフォルダ確認
2. SMTP送信ログ確認
3. DNSレコード設定確認
```

#### 3. リダイレクトエラー
```
症状: パスワードリセットページが正しく表示されない
解決策:
1. URL Configuration再確認
2. フロントエンドルーティング確認
3. ブラウザキャッシュクリア
```

## 📊 期待される効果

### 即時効果
- ✅ 全ユーザーのパスワードリセット機能復旧
- ✅ "Email address is invalid" エラーの解消
- ✅ ユーザー体験の向上

### 中長期効果
- ✅ 管理者手動対応の負荷軽減
- ✅ システムの信頼性向上
- ✅ スケーラビリティの確保
- ✅ セキュリティコンプライアンス改善

---

**作成日**: 2025-09-16
**作成者**: Claude Code
**承認**: 要承認
**更新予定**: SMTP設定完了後