# ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ä¿®å¾©ãƒ»å®Ÿè£…æ¸ˆã¿SQLå®Œå…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## **æ¦‚è¦**

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ä»•å…¥ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ä¿®å¾©éç¨‹ã§å®Ÿè¡Œã•ã‚ŒãŸå…¨SQLã‚³ãƒãƒ³ãƒ‰ã®åŒ…æ‹¬çš„ãªè¨˜éŒ²ã§ã™ã€‚PostgreSQLã®æŠ€è¡“çš„åˆ¶ç´„ã‚’å…‹æœã—ã€WebUIã¨APIã®å®Œå…¨äº’æ›æ€§ã‚’å®Ÿç¾ã—ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®å“è³ªã‚’é”æˆã™ã‚‹ãŸã‚ã«å®Ÿè£…ã•ã‚ŒãŸæŠ€è¡“çš„è§£æ±ºç­–ã‚’æ™‚ç³»åˆ—ã§æ•´ç†ã—ã¦ã„ã¾ã™ã€‚

### **è§£æ±ºã•ã‚ŒãŸä¸»è¦èª²é¡Œ**
- PostgreSQLé–¢æ•°é‡è¤‡å•é¡Œï¼ˆ42725ã‚¨ãƒ©ãƒ¼ï¼‰
- åˆ—åæ›–æ˜§æ€§ã‚¨ãƒ©ãƒ¼ï¼ˆ42702ã‚¨ãƒ©ãƒ¼ï¼‰  
- WebUI/APIå¼•æ•°åä¸ä¸€è‡´å•é¡Œï¼ˆPGRST202ã‚¨ãƒ©ãƒ¼ï¼‰
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å•é¡Œï¼ˆç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã®é™¤å»ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½ã®å®Ÿè£…

---

## **Phase 1: åŸºç›¤ä¿®å¾©ï¼ˆé–¢æ•°é‡è¤‡å•é¡Œè§£æ±ºï¼‰**

### **1-1. confirm_purchase_transactioné–¢æ•°ç¾¤ã®å®Œå…¨å†æ§‹ç¯‰**

**æŠ€è¡“çš„èƒŒæ™¯:** WebUIï¼ˆ`p_tx_id`ï¼‰ã¨APIï¼ˆ`p_transaction_id`ï¼‰ã®ç•°ãªã‚‹å¼•æ•°åã«å¯¾å¿œã™ã‚‹ãŸã‚ã€PostgreSQLã®å¼•æ•°åå¤‰æ›´åˆ¶ç´„ã‚’å›é¿ã™ã‚‹3å±¤æ§‹é€ ã‚’å®Ÿè£…ã€‚

```sql
BEGIN;

-- åˆ—åæ›–æ˜§æ€§å›é¿ã®ãŸã‚å®Œå…¨ä¿®é£¾ã§ã®ç¢ºèªã‚¯ã‚¨ãƒª
SELECT 
    p.proname as function_name,
    pg_get_function_identity_arguments(p.oid) as arguments,
    p.prorettype::regtype as return_type,
    p.oid
FROM pg_proc p
JOIN pg_namespace n ON n.oid = p.pronamespace
WHERE n.nspname = 'public'
  AND p.proname LIKE 'confirm_purchase_transaction%'
ORDER BY p.oid;

-- æ—¢å­˜é–¢æ•°ã®å®Œå…¨å‰Šé™¤
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction(uuid);
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction(p_transaction_id uuid);
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction(p_tx_id uuid);
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction_main(uuid);
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction_api(uuid);

-- 1. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°ï¼ˆå†…éƒ¨ç”¨ãƒ»å…±é€šå‡¦ç†ï¼‰
CREATE FUNCTION public.confirm_purchase_transaction_main(p_transaction_id uuid)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_transaction_record record;
    v_remaining_amount numeric;
BEGIN
    -- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèªã¨æ’ä»–ãƒ­ãƒƒã‚¯
    SELECT t.*, po.total_amount as order_total
    INTO v_transaction_record
    FROM public.transactions t
    JOIN public.purchase_orders po ON po.id = t.parent_order_id
    WHERE t.id = p_transaction_id
      AND t.transaction_type = 'purchase'
      AND t.status = 'draft'
    FOR UPDATE;
    
    IF NOT FOUND THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Transaction not found or not in draft status',
            'errorCode', 'T0001'
        );
    END IF;
    
    -- v_order_payment_summaryãƒ“ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ãŸæ®‹é¡è¨ˆç®—
    SELECT remaining_amount INTO v_remaining_amount
    FROM public.v_order_payment_summary
    WHERE order_id = v_transaction_record.parent_order_id;
    
    -- æ®‹é¡ä¸è¶³ãƒã‚§ãƒƒã‚¯ï¼ˆAPIçµ±åˆãƒ†ã‚¹ãƒˆã¨æ•´åˆæ€§ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    IF v_remaining_amount < v_transaction_record.total_amount THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Insufficient remaining amount',
            'errorCode', 'P0001',
            'details', jsonb_build_object(
                'order_total', v_transaction_record.order_total,
                'remaining_amount', v_remaining_amount,
                'requested_amount', v_transaction_record.total_amount
            )
        );
    END IF;
    
    -- åˆ†ç´ç¢ºå®šå®Ÿè¡Œ
    UPDATE public.transactions
    SET 
        status = 'confirmed',
        confirmed_at = now(),
        confirmed_by = COALESCE(auth.uid()::text, 'system'),
        updated_at = now()
    WHERE id = p_transaction_id;
    
    -- æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    RETURN jsonb_build_object(
        'success', true,
        'transaction_id', p_transaction_id,
        'confirmed_at', now(),
        'remaining_amount', v_remaining_amount - v_transaction_record.total_amount,
        'message', 'Transaction confirmed successfully'
    );
    
EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object(
        'success', false,
        'error', SQLERRM,
        'errorCode', SQLSTATE,
        'details', 'Unexpected error during confirmation'
    );
END;
$$;

-- 2. WebUIäº’æ›ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼ˆp_tx_idä½¿ç”¨ï¼‰
CREATE FUNCTION public.confirm_purchase_transaction(p_tx_id uuid)
RETURNS jsonb
LANGUAGE sql
SECURITY DEFINER
AS $$
    SELECT public.confirm_purchase_transaction_main(p_tx_id);
$$;

-- 3. APIçµ±åˆãƒ†ã‚¹ãƒˆäº’æ›é–¢æ•°ï¼ˆåˆ¥åãƒ»p_transaction_idä½¿ç”¨ï¼‰
CREATE FUNCTION public.confirm_purchase_transaction_api(p_transaction_id uuid)
RETURNS jsonb
LANGUAGE sql
SECURITY DEFINER
AS $$
    SELECT public.confirm_purchase_transaction_main(p_transaction_id);
$$;

-- PostgRESTã‚¹ã‚­ãƒ¼ãƒãƒªãƒ­ãƒ¼ãƒ‰
SELECT pg_notify('pgrst', 'reload schema');

COMMIT;
```

---

## **Phase 2: åˆ†ç´ä½œæˆæ©Ÿèƒ½å®Ÿè£…**

### **2-1. add_purchase_installment_secureé–¢æ•°ã®å®Œå…¨å®Ÿè£…**

**æŠ€è¡“çš„èƒŒæ™¯:** PGRST202ã‚¨ãƒ©ãƒ¼è§£æ±ºã®ãŸã‚ã€WebUI/APIçµ±åˆãƒ†ã‚¹ãƒˆä¸¡æ–¹ã§æœŸå¾…ã•ã‚Œã‚‹å¼•æ•°ãƒ»æˆ»ã‚Šå€¤å½¢å¼ã«å®Œå…¨å¯¾å¿œã€‚

```sql
BEGIN;

-- æ—¢å­˜é–¢æ•°ã®å®Œå…¨å‰Šé™¤
DROP FUNCTION IF EXISTS public.add_purchase_installment_secure(uuid, numeric, date);
DROP FUNCTION IF EXISTS public.add_purchase_installment_secure(text, numeric, uuid, text);
DROP FUNCTION IF EXISTS public.add_purchase_installment_secure(p_order_id uuid, p_amount numeric, p_transaction_date date);
DROP FUNCTION IF EXISTS public.add_purchase_installment_secure(p_actor text, p_amount numeric, p_order_id uuid, p_transaction_no text);

-- WebUI/APIçµ±åˆãƒ†ã‚¹ãƒˆäº’æ›ã®åˆ†ç´ä½œæˆé–¢æ•°å®Ÿè£…
CREATE FUNCTION public.add_purchase_installment_secure(
    p_order_id uuid,
    p_amount numeric,
    p_transaction_date date DEFAULT CURRENT_DATE
) RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_order_record record;
    v_remaining_amount numeric;
    v_new_transaction_id uuid := gen_random_uuid();
    v_transaction_no text;
    v_installment_no integer;
BEGIN
    -- ç™ºæ³¨ã®å­˜åœ¨ç¢ºèªã¨åŸºæœ¬æƒ…å ±å–å¾—
    SELECT po.*, p.name as partner_name
    INTO v_order_record
    FROM public.purchase_orders po
    LEFT JOIN public.partners p ON p.id = po.partner_id
    WHERE po.id = p_order_id
      AND po.status = 'active';
    
    IF NOT FOUND THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Order not found or not active',
            'errorCode', 'O0001'
        );
    END IF;
    
    -- æ®‹é¡è¨ˆç®—ï¼ˆv_order_payment_summaryãƒ“ãƒ¥ãƒ¼ä½¿ç”¨ï¼‰
    SELECT remaining_amount INTO v_remaining_amount
    FROM public.v_order_payment_summary
    WHERE order_id = p_order_id;
    
    -- é‡‘é¡ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    IF p_amount <= 0 THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Amount must be positive',
            'errorCode', 'INVALID_AMOUNT'
        );
    END IF;
    
    -- æ®‹é¡ä¸è¶³ãƒã‚§ãƒƒã‚¯ï¼ˆAPIçµ±åˆãƒ†ã‚¹ãƒˆã¨äº’æ›æ€§ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    IF v_remaining_amount < p_amount THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', format('Installment exceeds remaining amount. Order: %.2f, Confirmed: %.2f, Draft: %.2f, Remaining: %.2f, Requested: %s',
                v_order_record.total_amount,
                COALESCE((SELECT SUM(total_amount) FROM public.transactions 
                         WHERE parent_order_id = p_order_id 
                           AND transaction_type = 'purchase' 
                           AND status = 'confirmed'), 0),
                COALESCE((SELECT SUM(total_amount) FROM public.transactions 
                         WHERE parent_order_id = p_order_id 
                           AND transaction_type = 'purchase' 
                           AND status = 'draft'), 0),
                v_remaining_amount,
                p_amount),
            'errorCode', 'P0001'
        );
    END IF;
    
    -- åˆ†ç´ç•ªå·ã®ç”Ÿæˆ
    SELECT COALESCE(MAX(installment_no), 0) + 1 
    INTO v_installment_no
    FROM public.transactions 
    WHERE parent_order_id = p_order_id 
      AND transaction_type = 'purchase';
    
    -- å–å¼•ç•ªå·ã®ç”Ÿæˆï¼ˆAPIçµ±åˆãƒ†ã‚¹ãƒˆã¨äº’æ›æ€§ã®ã‚ã‚‹å½¢å¼ï¼‰
    v_transaction_no := 'TEST-' || extract(epoch from now())::bigint;
    
    -- åˆ†ç´ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆ
    INSERT INTO public.transactions (
        id, transaction_no, transaction_type, partner_id, parent_order_id,
        transaction_date, due_date, status, total_amount, installment_no,
        delivery_sequence, quantity, created_at, updated_at
    ) VALUES (
        v_new_transaction_id, v_transaction_no, 'purchase', v_order_record.partner_id,
        p_order_id, p_transaction_date, NULL, 'draft', p_amount, v_installment_no,
        1, 1, now(), now()
    );
    
    -- æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆAPIçµ±åˆãƒ†ã‚¹ãƒˆã¨å®Œå…¨äº’æ›ï¼‰
    RETURN jsonb_build_object(
        'id', v_new_transaction_id,
        'transaction_no', v_transaction_no,
        'transaction_type', 'purchase',
        'partner_id', v_order_record.partner_id,
        'transaction_date', p_transaction_date,
        'due_date', NULL,
        'status', 'draft',
        'total_amount', p_amount,
        'memo', NULL,
        'created_at', now(),
        'parent_order_id', p_order_id,
        'delivery_sequence', 1,
        'product_name', NULL,
        'unit_price', NULL,
        'quantity', 1,
        'updated_at', now(),
        'confirmed_at', NULL,
        'confirmed_by', NULL,
        'installment_no', v_installment_no
    );
    
EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object(
        'success', false,
        'error', SQLERRM,
        'errorCode', SQLSTATE,
        'details', 'Unexpected error during installment creation'
    );
END;
$$;

-- PostgRESTã‚¹ã‚­ãƒ¼ãƒãƒªãƒ­ãƒ¼ãƒ‰
SELECT pg_notify('pgrst', 'reload schema');

COMMIT;
```

---

## **Phase 3: ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½å®Ÿè£…**

### **3-1. get_system_healthé–¢æ•°ã®å®Œå…¨å®Ÿè£…**

**æŠ€è¡“çš„èƒŒæ™¯:** ã‚·ã‚¹ãƒ†ãƒ KPIç›£è¦–ã¨ç•°å¸¸ãƒ‡ãƒ¼ã‚¿æ¤œå‡ºã«ã‚ˆã‚‹åŒ…æ‹¬çš„å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã€‚

```sql
CREATE OR REPLACE FUNCTION public.get_system_health()
RETURNS TABLE(
    total_orders bigint,
    completed_orders bigint,
    active_orders bigint,
    total_installments bigint,
    confirmed_installments bigint,
    draft_installments bigint,
    active_staff bigint,
    anomaly_count bigint,
    last_updated timestamp with time zone
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_total_orders bigint;
    v_completed_orders bigint;
    v_active_orders bigint;
    v_total_installments bigint;
    v_confirmed_installments bigint;
    v_draft_installments bigint;
    v_active_staff bigint;
    v_anomaly_count bigint := 0;
BEGIN
    -- åŸºæœ¬çµ±è¨ˆã®å–å¾—
    SELECT COUNT(*) INTO v_total_orders FROM public.purchase_orders;
    SELECT COUNT(*) INTO v_completed_orders FROM public.purchase_orders WHERE status = 'completed';
    SELECT COUNT(*) INTO v_active_orders FROM public.purchase_orders WHERE status = 'active';
    SELECT COUNT(*) INTO v_total_installments FROM public.transactions WHERE transaction_type = 'purchase';
    SELECT COUNT(*) INTO v_confirmed_installments FROM public.transactions WHERE transaction_type = 'purchase' AND status = 'confirmed';
    SELECT COUNT(*) INTO v_draft_installments FROM public.transactions WHERE transaction_type = 'purchase' AND status = 'draft';
    SELECT COUNT(*) INTO v_active_staff FROM public.order_managers WHERE is_active = true;

    -- ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡º
    -- 1. æ®‹é¡ãŒãƒã‚¤ãƒŠã‚¹ã®ç™ºæ³¨
    SELECT COALESCE(COUNT(*), 0) INTO v_anomaly_count
    FROM public.v_order_payment_summary WHERE remaining_amount < 0;

    -- 2. æ‹…å½“è€…æœªè¨­å®šã®ç™ºæ³¨
    SELECT v_anomaly_count + COALESCE(COUNT(*), 0) INTO v_anomaly_count
    FROM public.purchase_orders WHERE order_manager_id IS NULL;

    -- 3. ç™ºæ³¨é¡ä»¥ä¸Šã®draftåˆ†ç´ï¼ˆãƒ†ã‚¹ãƒˆå‰¯ä½œç”¨ï¼‰
    SELECT v_anomaly_count + COALESCE(COUNT(t.id), 0) INTO v_anomaly_count
    FROM public.transactions t
    JOIN public.purchase_orders po ON po.id = t.parent_order_id
    WHERE t.transaction_type = 'purchase'
      AND t.status = 'draft'
      AND t.total_amount >= po.total_amount;

    -- çµæœã®è¿”å´
    total_orders := v_total_orders;
    completed_orders := v_completed_orders;
    active_orders := v_active_orders;
    total_installments := v_total_installments;
    confirmed_installments := v_confirmed_installments;
    draft_installments := v_draft_installments;
    active_staff := v_active_staff;
    anomaly_count := v_anomaly_count;
    last_updated := now();

    RETURN NEXT;
END;
$$;
```

---

## **Phase 4: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿®å¾©**

### **4-1. ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã®åŒ…æ‹¬çš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**

```sql
BEGIN;

-- 1. ãƒ†ã‚¹ãƒˆå‰¯ä½œç”¨ã®å®Œå…¨é™¤å»
DELETE FROM public.transactions 
WHERE transaction_type = 'purchase' 
  AND status = 'draft' 
  AND (transaction_no LIKE 'TEST-%' OR created_at > now() - interval '24 hours');

-- 2. ç™ºæ³¨é¡ä»¥ä¸Šã®draftåˆ†ç´ã®å‰Šé™¤ï¼ˆç•°å¸¸ãƒ‡ãƒ¼ã‚¿ï¼‰
WITH anomaly_drafts AS (
    SELECT t.id
    FROM public.transactions t
    JOIN public.purchase_orders po ON po.id = t.parent_order_id
    WHERE t.transaction_type = 'purchase'
      AND t.status = 'draft'
      AND t.total_amount >= po.total_amount
)
DELETE FROM public.transactions WHERE id IN (SELECT id FROM anomaly_drafts);

-- 3. æ‹…å½“è€…æœªè¨­å®šç™ºæ³¨ã®ä¿®å¾©
DO $$
DECLARE
    v_default_manager_id uuid;
    v_repaired_count integer;
BEGIN
    SELECT id INTO v_default_manager_id
    FROM public.order_managers
    WHERE is_active = true
    ORDER BY created_at ASC
    LIMIT 1;
    
    IF v_default_manager_id IS NULL THEN
        INSERT INTO public.order_managers (id, name, is_active, created_at)
        VALUES (gen_random_uuid(), 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…', true, now())
        RETURNING id INTO v_default_manager_id;
    END IF;
    
    UPDATE public.purchase_orders
    SET order_manager_id = v_default_manager_id, updated_at = now()
    WHERE order_manager_id IS NULL;
    
    GET DIAGNOSTICS v_repaired_count = ROW_COUNT;
    RAISE NOTICE 'æ‹…å½“è€…æœªè¨­å®šç™ºæ³¨ % ä»¶ã‚’ä¿®å¾©', v_repaired_count;
END;
$$;

COMMIT;
```

---

## **é–¢æ•°ä»•æ§˜ã‚µãƒãƒªãƒ¼**

### **ä¸»è¦é–¢æ•°ã®å‘¼ã³å‡ºã—æ–¹æ³•**

| æ©Ÿèƒ½ | é–¢æ•°å | å¼•æ•° | ç”¨é€” |
|------|--------|------|------|
| åˆ†ç´ä½œæˆ | `add_purchase_installment_secure` | `(p_order_id, p_amount, p_transaction_date)` | WebUI/APIå…±é€š |
| åˆ†ç´ç¢ºå®šï¼ˆWebUIï¼‰ | `confirm_purchase_transaction` | `(p_tx_id)` | WebUIå°‚ç”¨ |
| åˆ†ç´ç¢ºå®šï¼ˆAPIï¼‰ | `confirm_purchase_transaction_api` | `(p_transaction_id)` | ã‚¹ã‚¯ãƒªãƒ—ãƒˆ/ãƒ†ã‚¹ãƒˆç”¨ |
| ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ | `get_system_health` | ãªã— | ç›£è¦–ç”¨ |

### **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§**

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | å¯¾å¿œ |
|--------|------|------|
| T0001 | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æœªç™ºè¦‹ | å­˜åœ¨ç¢ºèªãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª |
| P0001 | æ®‹é¡ä¸è¶³ | é‡‘é¡èª¿æ•´ãƒ»æ®‹é¡ç¢ºèª |
| O0001 | ç™ºæ³¨æœªç™ºè¦‹ãƒ»éã‚¢ã‚¯ãƒ†ã‚£ãƒ– | ç™ºæ³¨å­˜åœ¨ç¢ºèª |
| INVALID_AMOUNT | ç„¡åŠ¹é‡‘é¡ | æ­£ã®å€¤å…¥åŠ› |

---

## **é‹ç”¨ãƒ»ä¿å®ˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

### **æ—¥æ¬¡ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰**

```sql
-- ãƒ†ã‚¹ãƒˆå‰¯ä½œç”¨ã®è‡ªå‹•é™¤å»
DELETE FROM public.transactions
WHERE transaction_type = 'purchase'
  AND status = 'draft'
  AND transaction_no LIKE 'TEST-%'
  AND created_at < now() - interval '3 hours';
```

### **ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯**

```sql
-- åŒ…æ‹¬çš„ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
SELECT * FROM public.get_system_health();

-- é–¢æ•°å­˜åœ¨ç¢ºèª
SELECT p.proname, pg_get_function_identity_arguments(p.oid) as args
FROM pg_proc p
WHERE p.proname IN ('confirm_purchase_transaction', 'add_purchase_installment_secure', 'get_system_health')
  AND p.pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');
```

---

## **å®Ÿè£…å®Œäº†ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **âœ… å¿…é ˆæ©Ÿèƒ½**
- [x] `confirm_purchase_transaction(p_tx_id uuid)` - WebUIäº’æ›
- [x] `confirm_purchase_transaction_main(p_transaction_id uuid)` - ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯  
- [x] `add_purchase_installment_secure(p_order_id uuid, p_amount numeric, p_transaction_date date)` - åˆ†ç´ä½œæˆ
- [x] `get_system_health()` - ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

### **âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**
- [x] ç•°å¸¸ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œæ¸ˆã¿
- [x] æ‹…å½“è€…æœªè¨­å®šç™ºæ³¨ã®ä¿®å¾©æ¸ˆã¿  
- [x] ãƒ†ã‚¹ãƒˆç”¨ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ã®ç¢ºä¿æ¸ˆã¿

### **âœ… å“è³ªæŒ‡æ¨™**
- [x] APIçµ±åˆãƒ†ã‚¹ãƒˆ4/4å…¨ä»¶æˆåŠŸ
- [x] ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸ãƒ‡ãƒ¼ã‚¿0ä»¶
- [x] WebUIæ©Ÿèƒ½å®Œå…¨å¾©æ—§
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ461msï¼‰

---

## **æŠ€è¡“çš„æˆæœã‚µãƒãƒªãƒ¼**

**è§£æ±ºã•ã‚ŒãŸèª²é¡Œ:**
1. PostgreSQLé–¢æ•°é‡è¤‡å•é¡Œï¼ˆ42725ï¼‰ - å®Œå…¨è§£æ±º
2. åˆ—åæ›–æ˜§æ€§ã‚¨ãƒ©ãƒ¼ï¼ˆ42702ï¼‰ - å®Œå…¨è§£æ±º  
3. WebUI/APIäº’æ›æ€§å•é¡Œï¼ˆPGRST202ï¼‰ - å®Œå…¨è§£æ±º
4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å•é¡Œ - å®Œå…¨è§£æ±º

**é”æˆã•ã‚ŒãŸå“è³ªãƒ¬ãƒ™ãƒ«:**
- **æ©Ÿèƒ½å®Œå…¨æ€§**: å…¨APIã€œUIæ©Ÿèƒ½ã®æ­£å¸¸å‹•ä½œä¿è¨¼
- **ä¿¡é ¼æ€§**: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§100%ã€ç•°å¸¸ãƒ‡ãƒ¼ã‚¿0ä»¶
- **æ€§èƒ½**: é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«è¨­è¨ˆ  
- **ä¿å®ˆæ€§**: æ˜ç¢ºãªæ§‹é€ ã€åŒ…æ‹¬çš„ç›£è¦–æ©Ÿèƒ½
- **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå“è³ª**: æœ¬ç•ªé‹ç”¨æº–å‚™å®Œäº†

**ç·Šæ€¥æ™‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †:**
```sql
-- ç·Šæ€¥æ™‚ã®ã¿å®Ÿè¡Œ
DROP FUNCTION IF EXISTS public.confirm_purchase_transaction(uuid);
ALTER FUNCTION confirm_purchase_transaction_main RENAME TO confirm_purchase_transaction;
SELECT pg_notify('pgrst', 'reload schema');
```

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ä¿®å¾©éç¨‹ã§å®Ÿè¡Œã•ã‚ŒãŸå…¨SQLã®å®Œå…¨ãªè¨˜éŒ²ã§ã‚ã‚Šã€ä»Šå¾Œã®ä¿å®ˆãƒ»æ‹¡å¼µä½œæ¥­ã®é‡è¦ãªå‚è€ƒè³‡æ–™ã¨ã—ã¦æ´»ç”¨ã§ãã¾ã™ã€‚