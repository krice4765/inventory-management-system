<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPCé–¢æ•°è¨ºæ–­ãƒ„ãƒ¼ãƒ« - create_safe_installment</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    .test-result {
      margin: 10px 0;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
    }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    pre {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.4;
    }

    .summary {
      background: #e7f3ff;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .config-section {
      background: #fff9e6;
      border: 1px solid #ffd700;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” RPCé–¢æ•°è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    <p style="text-align: center; color: #666;">create_safe_installment ã®404ã‚¨ãƒ©ãƒ¼æ ¹æœ¬åŸå› åˆ†æ</p>

    <div class="config-section">
      <h3>ğŸ“‹ Supabaseè¨­å®š</h3>
      <p><strong>URL:</strong> <code id="supabase-url">æœªè¨­å®š</code></p>
      <p><strong>Project ID:</strong> <code id="project-id">æœªè¨­å®š</code></p>
      <p><strong>APIã‚­ãƒ¼:</strong> <code id="api-key">æœªè¨­å®š</code></p>
      <button onclick="showSupabaseConfig()">è¨­å®šè¡¨ç¤º</button>
    </div>

    <div class="summary" id="summary" style="display:none;">
      <h3>ğŸ“Š è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼</h3>
      <p id="summary-content">è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
    </div>

    <div class="test-section">
      <h3>ğŸš€ è¨ºæ–­å®Ÿè¡Œ</h3>
      <button id="run-basic" onclick="runBasicDiagnostic()">åŸºæœ¬è¨ºæ–­</button>
      <button id="run-full" onclick="runFullDiagnostic()">å®Œå…¨è¨ºæ–­</button>
      <button id="run-rpc-only" onclick="runRPCOnlyTest()">RPCé–¢æ•°ã®ã¿ãƒ†ã‚¹ãƒˆ</button>
      <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
    </div>

    <div id="results-container">
      <!-- è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
    </div>

    <div class="test-section">
      <h3>ğŸ› ï¸ ç·Šæ€¥å¯¾å¿œæ‰‹é †</h3>
      <div class="info test-result">
        <h4>Phase 1: å³åº§ç¢ºèªï¼ˆæ¨å¥¨ï¼‰</h4>
        <p>1. ã€ŒRPCé–¢æ•°ã®ã¿ãƒ†ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
        <p>2. 404ã‚¨ãƒ©ãƒ¼ãŒç¶™ç¶šã™ã‚‹å ´åˆ â†’ æœ¬ç•ªç’°å¢ƒã§fix_installment_schema.sqlã‚’å®Ÿè¡Œ</p>
        <p>3. ãã®ä»–ã‚¨ãƒ©ãƒ¼ â†’ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸ä¸€è‡´ã®ä¿®æ­£ãŒå¿…è¦</p>

        <h4>Phase 2: ç’°å¢ƒç¢ºèª</h4>
        <p>1. VITE_SUPABASE_URL ã¨ VITE_SUPABASE_ANON_KEY ã®ç’°å¢ƒå¤‰æ•°ç¢ºèª</p>
        <p>2. æœ¬ç•ªSupabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ (tleequspizctgoosostd) ã¸ã®æ¥ç¶šç¢ºèª</p>

        <h4>Phase 3: ãƒ‡ãƒ—ãƒ­ã‚¤åŒæœŸ</h4>
        <p>1. Supabase Dashboard â†’ SQL Editor</p>
        <p>2. fix_installment_schema.sql ã®å†…å®¹ã‚’å®Ÿè¡Œ</p>
        <p>3. é–¢æ•°ä½œæˆå¾Œ24æ™‚é–“ä»¥å†…ã«ä¼æ’­å®Œäº†</p>
      </div>
    </div>
  </div>

  <script>
    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ï¼‰
    let supabase = null;

    function initSupabase() {
      // æœ¬ç•ªç’°å¢ƒã®è¨­å®šï¼ˆå®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
      const SUPABASE_URL = 'https://tleequspizctgoosostd.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsZWVxdXNwaXpjdGdvb3Nvc3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU4NTk4NTksImV4cCI6MjA0MTQzNTg1OX0.tVAaoB3gaBKQ-ItYoxfhfaU6YOQOmKrLRyA7Mf6Fhzs';

      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // è¨­å®šè¡¨ç¤º
      document.getElementById('supabase-url').textContent = SUPABASE_URL;
      document.getElementById('project-id').textContent = SUPABASE_URL.match(/https:\/\/(.+?)\.supabase\.co/)?.[1] || 'ä¸æ˜';
      document.getElementById('api-key').textContent = SUPABASE_ANON_KEY.substring(0, 30) + '...';
    }

    function showSupabaseConfig() {
      const config = {
        URL: supabase?.supabaseUrl,
        KEY: supabase?.supabaseKey?.substring(0, 50) + '...',
        auth: supabase?.auth
      };
      addResult('è¨­å®šç¢ºèª', 'info', 'Supabaseè¨­å®š', JSON.stringify(config, null, 2));
    }

    function addResult(testName, status, message, details = null) {
      const container = document.getElementById('results-container');
      const result = document.createElement('div');
      result.className = `test-result ${status}`;

      const icon = status === 'success' ? 'âœ…' :
                  status === 'warning' ? 'âš ï¸' :
                  status === 'error' ? 'âŒ' : 'ğŸ“‹';

      let html = `<strong>${icon} ${testName}:</strong> ${message}`;

      if (details) {
        html += `<pre>${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}</pre>`;
      }

      result.innerHTML = html;
      container.appendChild(result);

      // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      result.scrollIntoView({ behavior: 'smooth' });
    }

    function clearResults() {
      document.getElementById('results-container').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
    }

    function setButtonLoading(buttonId, loading) {
      const button = document.getElementById(buttonId);
      if (loading) {
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div>è¨ºæ–­ä¸­...';
      } else {
        button.disabled = false;
        button.innerHTML = button.id.includes('basic') ? 'åŸºæœ¬è¨ºæ–­' :
                          button.id.includes('full') ? 'å®Œå…¨è¨ºæ–­' : 'RPCé–¢æ•°ã®ã¿ãƒ†ã‚¹ãƒˆ';
      }
    }

    async function runBasicDiagnostic() {
      setButtonLoading('run-basic', true);

      try {
        addResult('åŸºæœ¬è¨ºæ–­é–‹å§‹', 'info', 'æ¥ç¶šç¢ºèªã¨RPCé–¢æ•°å­˜åœ¨ãƒã‚§ãƒƒã‚¯');

        // Test 1: Supabaseæ¥ç¶šç¢ºèª
        await testSupabaseConnection();

        // Test 2: RPCé–¢æ•°ãƒ†ã‚¹ãƒˆ
        await testRPCFunction();

        addResult('åŸºæœ¬è¨ºæ–­å®Œäº†', 'success', 'åŸºæœ¬è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        addResult('åŸºæœ¬è¨ºæ–­ã‚¨ãƒ©ãƒ¼', 'error', error.message, error);
      }

      setButtonLoading('run-basic', false);
    }

    async function runFullDiagnostic() {
      setButtonLoading('run-full', true);

      try {
        addResult('å®Œå…¨è¨ºæ–­é–‹å§‹', 'info', 'ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™');

        await testSupabaseConnection();
        await testRPCFunction();
        await testRPCParameters();
        await testPermissions();

        showSummary();
        addResult('å®Œå…¨è¨ºæ–­å®Œäº†', 'success', 'ã™ã¹ã¦ã®è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        addResult('å®Œå…¨è¨ºæ–­ã‚¨ãƒ©ãƒ¼', 'error', error.message, error);
      }

      setButtonLoading('run-full', false);
    }

    async function runRPCOnlyTest() {
      setButtonLoading('run-rpc-only', true);

      try {
        addResult('RPCé–¢æ•°ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info', 'create_safe_installmenté–¢æ•°ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆ');
        await testRPCFunction();
        addResult('RPCé–¢æ•°ãƒ†ã‚¹ãƒˆå®Œäº†', 'success', 'RPCé–¢æ•°ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        addResult('RPCé–¢æ•°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', 'error', error.message, error);
      }

      setButtonLoading('run-rpc-only', false);
    }

    async function testSupabaseConnection() {
      try {
        const { data, error } = await supabase
          .from('purchase_orders')
          .select('count')
          .limit(1);

        if (error) {
          addResult('Supabaseæ¥ç¶š', 'error', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•—', error);
          throw error;
        }

        addResult('Supabaseæ¥ç¶š', 'success', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ­£å¸¸');
      } catch (error) {
        addResult('Supabaseæ¥ç¶š', 'error', 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¾‹å¤–', error);
        throw error;
      }
    }

    async function testRPCFunction() {
      try {
        const testOrderId = '00000000-0000-4000-8000-000000000001';

        const { data, error } = await supabase.rpc('create_safe_installment', {
          p_parent_order_id: testOrderId,
          p_partner_id: null,
          p_transaction_date: '2025-09-16',
          p_due_date: '2025-09-23',
          p_total_amount: 1000.00,
          p_memo: 'RPCè¨ºæ–­ãƒ†ã‚¹ãƒˆ'
        });

        if (error) {
          // 404ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ
          if (error.message?.includes('does not exist') || error.code === '42883') {
            addResult('RPCé–¢æ•°', 'error',
              'ğŸš¨ 404 Not Found - é–¢æ•°ãŒæœ¬ç•ªç’°å¢ƒã«å­˜åœ¨ã—ã¾ã›ã‚“',
              {
                error_code: error.code,
                message: error.message,
                solution: 'æœ¬ç•ªSupabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§fix_installment_schema.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„',
                sql_file: 'fix_installment_schema.sql',
                function_name: 'create_safe_installment'
              }
            );
            return;
          }

          addResult('RPCé–¢æ•°', 'error', `RPCå‘¼ã³å‡ºã—å¤±æ•—: ${error.message}`, error);
          return;
        }

        addResult('RPCé–¢æ•°', 'success', 'RPCé–¢æ•°å‘¼ã³å‡ºã—æˆåŠŸ', data);
      } catch (error) {
        addResult('RPCé–¢æ•°', 'error', 'RPCå‘¼ã³å‡ºã—ä¾‹å¤–', error);
      }
    }

    async function testRPCParameters() {
      try {
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å®Œå…¨ç‰ˆãƒ†ã‚¹ãƒˆ
        const testOrderId = '00000000-0000-4000-8000-000000000002';

        const { data, error } = await supabase.rpc('create_safe_installment', {
          p_parent_order_id: testOrderId,
          p_partner_id: '00000000-0000-4000-8000-000000000003',
          p_transaction_date: '2025-09-16',
          p_due_date: '2025-09-23',
          p_total_amount: 2500.00,
          p_memo: 'RPCå®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ',
          p_delivery_sequence: 1,
          p_product_name: 'ãƒ†ã‚¹ãƒˆå•†å“',
          p_unit_price: 2500.00,
          p_quantity: 1
        });

        if (error) {
          addResult('RPCå®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', 'error', `å®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿RPCå¤±æ•—: ${error.message}`, error);
          return;
        }

        addResult('RPCå®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', 'success', 'å®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿RPCæˆåŠŸ', data);
      } catch (error) {
        addResult('RPCå®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿', 'error', 'å®Œå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿RPCä¾‹å¤–', error);
      }
    }

    async function testPermissions() {
      try {
        const { data, error } = await supabase.auth.getUser();

        if (error) {
          addResult('æ¨©é™ç¢ºèª', 'warning', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—ï¼ˆåŒ¿åã‚¢ã‚¯ã‚»ã‚¹ï¼‰', error);
          return;
        }

        const userRole = data.user ? 'authenticated' : 'anon';

        addResult('æ¨©é™ç¢ºèª', 'success', `ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«: ${userRole}`, {
          user_id: data.user?.id,
          role: userRole,
          expected_grants: ['authenticated', 'anon']
        });
      } catch (error) {
        addResult('æ¨©é™ç¢ºèª', 'error', 'æ¨©é™ç¢ºèªä¾‹å¤–', error);
      }
    }

    function showSummary() {
      const results = document.querySelectorAll('.test-result');
      const total = results.length;
      const success = document.querySelectorAll('.test-result.success').length;
      const errors = document.querySelectorAll('.test-result.error').length;
      const warnings = document.querySelectorAll('.test-result.warning').length;

      const summaryContent = `
        <p><strong>ç·ãƒ†ã‚¹ãƒˆæ•°:</strong> ${total}</p>
        <p><strong>æˆåŠŸ:</strong> ${success} <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${errors} <strong>è­¦å‘Š:</strong> ${warnings}</p>
        <p><strong>æˆåŠŸç‡:</strong> ${Math.round((success / total) * 100)}%</p>
      `;

      document.getElementById('summary-content').innerHTML = summaryContent;
      document.getElementById('summary').style.display = 'block';
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Supabaseã‚’åˆæœŸåŒ–
    window.addEventListener('load', () => {
      initSupabase();
      addResult('åˆæœŸåŒ–', 'info', 'RPCè¨ºæ–­ãƒ„ãƒ¼ãƒ«ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ');
    });
  </script>
</body>
</html>