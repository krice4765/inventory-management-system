# システム整合性問題分析・修正計画書

## 実行概要
日時: 2025-09-15
担当: Claude Code システムアーキテクト
目的: データ整合性ダッシュボードで検出された問題の根本原因分析と修正実行

## 検出問題の詳細分析

### 🔴 最優先問題：発注書金額の不整合（14件）

**問題内容:**
- purchase_orders.total_amount ≠ SUM(purchase_order_items.total_amount)
- アイテム合計金額と発注書総額が一致しない

**根本原因分析:**
1. **データ更新の非同期性**: アイテム追加/削除時に発注書総額の再計算が漏れている
2. **計算精度問題**: 小数点計算での丸め誤差の蓄積
3. **トランザクション不整合**: アイテム更新と発注書更新が別トランザクションで実行

**技術的調査項目:**
- purchase_order_items テーブルの total_amount 計算ロジック
- purchase_orders テーブルの total_amount 更新タイミング
- フロントエンドでの金額計算処理

### 🟡 中優先問題：在庫数量の不整合（1件）

**問題内容:**
- products.current_stock ≠ SUM(inventory_movements による計算値)
- 在庫移動履歴と現在庫数が一致しない

**根本原因分析:**
1. **初期在庫の設定不備**: 初期在庫が inventory_movements に記録されていない
2. **移動タイプの不統一**: 'in'/'out'以外の移動タイプの存在
3. **削除済みレコードの影響**: 論理削除されたレコードの計算への影響

### 🟡 中優先問題：分納金額の不整合（1件）

**問題内容:**
- purchase_orders.remaining_amount ≠ (total_amount - SUM(transactions.total_amount))
- 分納記録と残額の計算が一致しない

**根本原因分析:**
1. **分納記録の重複**: 同一分納の重複記録
2. **ステータス管理**: 'confirmed'以外のステータスの扱い
3. **親注文の参照**: parent_order_id の不正な設定

### 🟢 低優先問題：発注アイテム金額の不整合（1件）

**問題内容:**
- アイテムレベルでの金額計算エラー
- quantity * unit_price ≠ total_amount

## 修正戦略とアプローチ

### フェーズ1: 緊急対応（発注書金額不整合）
1. **現状調査**: 不整合データの詳細分析
2. **安全な修正**: バックアップ作成後の段階的修正
3. **検証**: 修正後の整合性確認

### フェーズ2: 中期改善（在庫・分納）
1. **在庫管理の強化**: 移動履歴の正規化
2. **分納管理の改善**: 重複防止とステータス統一
3. **自動修正機能**: 定期的な整合性チェックと自動修正

### フェーズ3: 長期対策（システム強化）
1. **データベース制約**: 外部キー制約とチェック制約の追加
2. **アプリケーション改善**: トランザクション管理の強化
3. **監視システム**: リアルタイム整合性監視の実装

## 技術実装計画

### 1. 修正用SQL関数の作成
```sql
-- 発注書金額修正関数
CREATE OR REPLACE FUNCTION fix_purchase_order_totals()
RETURNS TABLE(fixed_count INTEGER, error_count INTEGER);

-- 在庫数量修正関数
CREATE OR REPLACE FUNCTION fix_inventory_quantities()
RETURNS TABLE(fixed_count INTEGER, error_count INTEGER);

-- 分納残額修正関数
CREATE OR REPLACE FUNCTION fix_delivery_remaining_amounts()
RETURNS TABLE(fixed_count INTEGER, error_count INTEGER);
```

### 2. バックアップ・ロールバック機能
```sql
-- 修正前バックアップテーブル作成
CREATE TABLE backup_purchase_orders_YYYYMMDD AS SELECT * FROM purchase_orders;
CREATE TABLE backup_products_YYYYMMDD AS SELECT * FROM products;
```

### 3. 検証・監視機能の強化
- リアルタイム整合性チェック
- 自動アラート機能
- 修正履歴の記録

## リスク評価と緩和策

### 高リスク項目
1. **データ損失リスク**: 修正処理中のデータ破損
   - 緩和策: 完全バックアップの事前作成
2. **業務停止リスク**: 修正中のシステム利用不可
   - 緩和策: オフピーク時間での実行、段階的修正

### 中リスク項目
1. **計算精度リスク**: 修正後の新たな不整合
   - 緩和策: 複数回の検証、小数点精度の統一
2. **パフォーマンス影響**: 大量データ処理による負荷
   - 緩和策: バッチ処理、処理時間の監視

## 実行タイムライン

### 即座実行（フェーズ1）
- [x] 問題分析完了
- [ ] 修正用関数作成（30分）
- [ ] バックアップ作成（15分）
- [ ] 段階的修正実行（45分）
- [ ] 検証・確認（20分）

### 今後1週間（フェーズ2）
- [ ] 在庫管理改善
- [ ] 分納管理改善
- [ ] 自動修正機能実装

### 今後1ヶ月（フェーズ3）
- [ ] データベース制約強化
- [ ] アプリケーション改善
- [ ] 監視システム実装

## 成功指標
- 整合性エラー件数: 17件 → 0件
- 整合性チェック実行時間: < 5秒
- 自動修正成功率: > 95%
- システム稼働率: > 99.9%

## 次のアクション
1. 修正用SQL関数の作成と実行
2. 整合性ダッシュボードでの確認
3. 再発防止策の実装
4. 定期監視システムの構築

---
*このドキュメントは進行状況に応じて随時更新されます*