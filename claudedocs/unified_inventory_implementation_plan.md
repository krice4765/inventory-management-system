# 統合在庫履歴表示の実装計画

## 📋 実装概要
Inventoryページで在庫移動履歴に加えて、金額のみ分納レコードも含む統合履歴表示を実装

## 🎯 実装目標
1. **統合データ取得**: inventory_movements + transactions の統合表示
2. **分納情報可視化**: 金額のみ分納も含む全分納記録の表示
3. **詳細情報追加**: 発注番号、分納回数、金額情報を各カラムに表示

## 📋 なぜこの実装計画に至ったか

### 💡 問題の発見
1. **UI/UX改善フェーズでの気づき**
   - Products, Orders, Inventoryページの改善作業中
   - 日付フィルター精度問題、バッジデザイン改善を実施
   - ユーザーから「金額のみ分納では在庫変動なし→この処理の反映先がいまのところない」という指摘

2. **現在のInventory表示の限界**
   - ユーザー提供のスクリーンショットで判明：現在のInventoryページには金額情報が不足
   - inventory_movementsテーブルのみ表示 → 金額のみ分納レコードが見えない
   - 発注番号、分納回数などの重要な文脈情報が欠如

3. **システム設計の矛盾発見**
   - 金額のみ分納は在庫変動なしに修正済み（inventoryIntegration.ts:164-170）
   - しかし履歴として残すべき会計記録が可視化されていない状況

### 🔍 要件分析の過程
1. **ユーザー要望の整理**
   - 「金額のみ分納の可視化（参考情報として）」
   - 「金額＋個数を指定して分納時の金額や、全納時のものも可視化する認識はある？」→ Yes
   - 「現状のinventoryページの表示はスクショ」→ 金額情報不足を確認

2. **システム境界の明確化**
   - 在庫管理システム vs 会計システムの分離方針を確認
   - 在庫管理では物理的な商品移動のみ管理
   - 金額配分は会計システムの責任範囲
   - **結論**: 金額のみ分納は参考情報として表示（編集不可）

3. **データ構造の調査**
   - inventory_movements: 物理的な在庫移動記録
   - transactions: 分納記録（金額のみ分納含む）
   - purchase_orders: 発注情報（発注番号、総額）
   - 既存のuseAllMovementsは一部統合済み、但し金額のみ分納は未対応

### 🏗️ 設計方針の決定
1. **統合表示アプローチ**
   - 既存のinventory_movementsベースの表示を拡張
   - transactionsテーブルから金額のみ分納レコードを追加取得
   - 統一インターフェース（UnifiedInventoryRecord）で両方を管理

2. **情報階層の設計**
   - 基本情報: 日時、商品、記録種別
   - 在庫情報: 数量、移動後在庫（在庫移動時のみ）
   - 分納情報: 金額、発注番号、分納回数（分納時のみ）

3. **UI設計原則**
   - 既存のInventoryページデザインを踏襲
   - 記録種別を明確に区別（バッジで視覚化）
   - 情報の過多を避け、文脈に応じた表示制御

### 📈 段階的実装の理由
1. **Phase 1 (データ統合)**:
   - 既存のuseAllMovementsフックは高機能だが金額のみ分納未対応
   - まずデータレイヤーで統合ロジックを完成させる

2. **Phase 2 (UI拡張)**:
   - 現在のVirtualizedInventoryTable.tsxは既に高度な表示機能を持つ
   - カラム情報を段階的に拡張し、破綻リスクを最小化

3. **Phase 3 (フィルタ拡張)**:
   - 既存フィルタシステムの拡張
   - ユーザビリティの最終調整

### ⚖️ 技術的制約の考慮
1. **パフォーマンス制約**
   - 無限スクロール対応必須（既存仕様）
   - 複雑なJOINクエリによる応答時間への影響を最小化

2. **データ整合性**
   - inventory_movementsが真の在庫状況
   - transactionsは補完的な会計情報
   - 矛盾時はinventory_movements優先の原則

3. **保守性**
   - 既存コードへの影響最小化
   - 在庫管理と会計の責任分離を維持

## 📦 Phase 1: データ統合レイヤー（1週間）
### 1.1 統合インターフェース定義
```typescript
interface UnifiedInventoryRecord {
  // 共通項目
  id: string;
  record_type: 'inventory_movement' | 'amount_only_transaction';
  product_id: string;
  products: Product;
  created_at: string;

  // 在庫移動項目
  movement_type?: 'in' | 'out';
  quantity?: number;
  cumulative_stock_at_time?: number;

  // 分納情報
  transaction_id?: string;
  delivery_amount?: number;
  installment_no?: number;
  order_no?: string;
  unit_price?: number;
  memo: string;
}
```

### 1.2 useAllMovements拡張
- transactionsテーブルから金額のみ分納レコード取得
- inventory_movementsと統合してUnifiedInventoryRecord[]として返却
- 時系列ソート、フィルタリング機能維持

## 🎨 Phase 2: UI表示拡張（1.5週間）
### 2.1 移動数量カラム拡張
- 数量表示（在庫移動時のみ）
- 金額表示（全レコード）
- 単価表示（計算または直接取得）

### 2.2 在庫変化カラム拡張
- 移動後在庫（在庫移動時のみ）
- 分納回数表示（分納レコード時）
- 発注番号表示（リンク化）

### 2.3 移動タイプ表示拡張
- 既存: 入庫/出庫バッジ
- 追加: 「金額分納」バッジ（グレー系）

## 🔍 Phase 3: フィルタ機能拡張（0.5週間）
### 3.1 フィルタオプション追加
- レコード種別フィルタ（在庫移動/金額分納/全て）
- 分納回数フィルタ
- 発注番号検索

## 📊 成功指標
1. **統合表示完了**: 在庫移動 + 金額分納の一元表示
2. **情報完全性**: 発注番号、分納回数、金額情報の完全表示
3. **フィルタ精度**: 全レコード種別の正確な絞り込み
4. **パフォーマンス**: 統合クエリでも2秒以内の応答

## ⚠️ 技術的考慮事項
- **在庫管理 vs 会計の分離**: 金額分納は参考情報として表示（編集不可）
- **データ整合性**: inventory_movements優先、transactions補完
- **パフォーマンス**: LEFT JOINでの効率的な統合クエリ設計

## 🚀 実装開始点
Phase 1の`useAllMovements`フック拡張から開始。現在のコードベースを活用し、段階的に機能を追加する方針。

## 📝 実装履歴
- **UI/UX改善完了**: 2025-09-13 - Products/Orders/Inventoryページの表示改善、金額のみ分納の在庫変動停止
- **計画策定完了**: 2025-09-13 - 統合在庫履歴表示の詳細実装計画確定
- **次回開始予定**: Phase 1 データ統合レイヤーの実装