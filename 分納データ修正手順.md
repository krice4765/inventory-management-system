# 🛡️ 分納データ修正手順書

**重要**: 必ずこの手順に従って、安全にデータ修正を実行してください。

## 📋 事前準備

### 1. バックアップ作成（必須）

ブラウザの開発者コンソールで以下を実行：

```javascript
// 🛡️ 全分納データのバックアップ作成
await createBackup.all()

// 🛡️ 特定発注書のバックアップ作成（例：PO250917015）
await createBackup.order('PO250917015')
```

**確認事項:**
- [ ] バックアップファイルがダウンロードされた
- [ ] ファイル名に現在日時が含まれている
- [ ] ファイルサイズが0でない

## 🔧 データ修正実行

### 2. 現状確認

```javascript
// 📊 修正前のデータ状況確認
await fixInstallmentData.check('PO250917015')
```

### 3. テスト修正（1つの発注書）

```javascript
// 🧪 PO250917015のみ修正実行
await fixInstallmentData.fixOrder('PO250917015')
```

### 4. 修正結果確認

```javascript
// ✅ 修正後のデータ確認
await fixInstallmentData.check('PO250917015')
```

**確認項目:**
- [ ] installment_no が 1, 2, 3... の順序になっている
- [ ] memo が「第1回」「第2回」「第3回」に変更されている
- [ ] delivery_sequence も正しく設定されている

### 5. ブラウザでの表示確認

1. **分納履歴**: 1回目〜3回目が正しい順序で表示
2. **inventoryページ**: 各分納が正しい回数で表示
3. **分納モーダル**: 履歴が正しく表示

## 🚀 全データ修正（テスト成功後）

### 6. 全発注書一括修正

```javascript
// ⚠️ 全発注書一括修正（時間がかかります）
await fixInstallmentData.fixAll()
```

**注意事項:**
- この処理は5-10分程度かかる場合があります
- 処理中はブラウザを閉じないでください
- 完了まで待機してください

## 🔄 トラブル時の復旧

### バックアップからの復旧手順

1. **Supabaseダッシュボードにアクセス**
2. **SQL Editorを開く**
3. **バックアップデータを使用してテーブルを復元**

```sql
-- 例：transactionsテーブルの復旧
DELETE FROM transactions WHERE transaction_type = 'purchase';
-- バックアップファイルのtransactionsデータを挿入
```

## ✅ 修正完了チェックリスト

- [ ] バックアップ作成完了
- [ ] テスト修正成功
- [ ] 表示確認完了
- [ ] 全データ修正完了
- [ ] 最終動作確認完了

## 📞 問題発生時の対応

1. **即座に作業を停止**
2. **エラーログをコピー保存**
3. **バックアップファイルを確認**
4. **必要に応じて復旧実行**

---

**作成日**: 2025-09-17
**対象システム**: 仕入管理システム
**目的**: 分納回数表示修正