# 在庫移動履歴と発注情報の連携問題レポート

## 📋 調査概要
- **対象発注**: PO250920003 (¥31,625)
- **調査日時**: 2025-09-20
- **調査範囲**: 分納履歴と在庫移動の連携状況

## 🔍 発見した問題

### 1. 連携不完全問題
| 分納 | 分納ID | installment_no | 連携在庫移動 | 状況 |
|------|--------|----------------|--------------|------|
| 分納1 | 0f424a15-68cb-4639-94c2-454e2f144294 | 1 | **0件** | ❌ 完全未連携 |
| 分納2 | b5ec94dc-c1a0-4f8f-b398-1185e7b106eb | 2 | 1件 | ⚠️ 部分連携 |
| 分納3 | 94c119b7-89c3-41b7-836e-fa2dbbbc8be8 | 3 | 1件 | ⚠️ 部分連携 |

### 2. 未連携在庫移動
- **未連携件数**: 6件/8件 (75%が未連携)
- **分納番号での関連**: 第1回:4件、第2回:3件、第3回:1件
- **transaction_idでの関連**: 異なるIDを参照

### 3. 分納番号の不整合
```
分納1: installment_no=1, memo="" (空)
分納2: installment_no=2, memo="第1回" ← 番号と表示が不一致
分納3: installment_no=3, memo="第3回" ← 分納2が「第1回」なのに第3回？
```

## 🎯 推定される原因

### A. システム統合不備
- 分納作成時に在庫移動が自動生成されていない
- 在庫移動は別システム/手動で登録されている
- transaction_idの連携ロジックに問題

### B. データ整合性問題
- installment_noとmemoの表示不一致
- 分納と在庫移動のタイミングずれ
- 重複データ生成の可能性

## 💊 解決策

### 即時対応（手動修正）
1. **未連携在庫移動の修正**
   ```sql
   -- 在庫移動のtransaction_idを正しい分納IDに更新
   UPDATE inventory_movements
   SET transaction_id = '正しい分納ID'
   WHERE installment_no = 1 AND transaction_id != '0f424a15-68cb-4639-94c2-454e2f144294';
   ```

2. **表示修正**
   - 分納2のmemoを「第2回」に修正
   - DeliveryHistoryList.tsxの表示ロジック確認

### 根本対策（システム改修）
1. **自動連携機能実装**
   - 分納作成時に在庫移動を自動生成
   - transaction_idの正しい連携保証

2. **データ整合性チェック**
   - 分納番号とmemoの一致検証
   - 重複防止機能

3. **監視機能追加**
   - 未連携データの定期チェック
   - アラート機能

## 📈 優先度
1. **高**: 分納1の在庫移動0件問題
2. **中**: 未連携在庫移動の修正
3. **低**: 表示不整合の修正

## 🔄 次のアクション
1. 手動でデータ修正を実行
2. 自動連携機能の設計・実装
3. 定期監視機能の追加