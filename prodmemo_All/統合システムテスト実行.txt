// çµ±åˆã‚·ã‚¹ãƒ†ãƒ æœ¬æ ¼ãƒ†ã‚¹ãƒˆ - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ

console.log('ğŸ§ª çµ±åˆã‚·ã‚¹ãƒ†ãƒ æœ¬æ ¼ãƒ†ã‚¹ãƒˆé–‹å§‹');

// Step 1: v3é–¢æ•°ã§æ–°ã—ã„çµ±åˆåˆ†ç´ã‚’ä½œæˆï¼ˆå•†å“æƒ…å ±ä»˜ãï¼‰
const testInstallmentV3 = async () => {
  const { data, error } = await supabase.rpc('add_purchase_installment_v3', {
    p_parent_order_id: window.order.id,
    p_amount: 8000,
    p_products: [
      {
        product_id: '037ac88a-6691-47a6-8d9b-5bb6d579dd62',
        quantity: 2,
        unit_price: 3000
      },
      {
        product_id: '8f3a6dce-f35e-45ab-b44d-5b51e7989868',
        quantity: 1,
        unit_price: 2000
      }
    ],
    p_memo: 'v3çµ±åˆãƒ†ã‚¹ãƒˆåˆ†ç´'
  });

  console.log('v3åˆ†ç´ä½œæˆçµæœ:', { data, error });
  return { data, error };
};

// Step 2: çµ±åˆæ¤œè¨¼ã‚’å®Ÿè¡Œ
const validateIntegration = async () => {
  const { data, error } = await supabase.rpc('validate_installment_integration', {
    p_parent_order_id: window.order.id
  });

  console.log('çµ±åˆæ¤œè¨¼çµæœ:', { data, error });
  return { data, error };
};

// Step 3: è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œï¼ˆæ—¢å­˜ã®æœªé€£æºãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
const repairIntegration = async () => {
  const { data, error } = await supabase.rpc('repair_installment_inventory_integration', {
    p_parent_order_id: window.order.id
  });

  console.log('è‡ªå‹•ä¿®å¾©çµæœ:', { data, error });
  return { data, error };
};

// Step 4: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹
const runFullIntegrationTest = async () => {
  console.log('ğŸ“‹ Phase 1: ç¾åœ¨ã®çµ±åˆçŠ¶æ³ç¢ºèª');
  const validation1 = await validateIntegration();

  console.log('ğŸ“‹ Phase 2: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ä¿®å¾©');
  const repair = await repairIntegration();

  console.log('ğŸ“‹ Phase 3: v3çµ±åˆåˆ†ç´ä½œæˆãƒ†ã‚¹ãƒˆ');
  const v3Result = await testInstallmentV3();

  console.log('ğŸ“‹ Phase 4: ä¿®å¾©å¾Œã®çµ±åˆçŠ¶æ³ç¢ºèª');
  const validation2 = await validateIntegration();

  console.log('ğŸ“‹ Phase 5: åœ¨åº«ç§»å‹•ç¢ºèª');
  const movements = await supabase
    .from('inventory_movements')
    .select('*')
    .gte('created_at', '2025-09-20T00:00:00')
    .order('created_at', { ascending: false });

  console.log('æœ€æ–°åœ¨åº«ç§»å‹•:', movements.data);

  console.log('ğŸ‰ çµ±åˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Œäº†');

  return {
    beforeValidation: validation1.data,
    repairResult: repair.data,
    v3InstallmentResult: v3Result.data,
    afterValidation: validation2.data,
    latestMovements: movements.data
  };
};

// å®Ÿè¡Œç”¨ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œï¼‰
// runFullIntegrationTest();