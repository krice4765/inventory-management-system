# 統合在庫システム導入手順

## 🎯 導入概要
分納と在庫移動の自動連携システムを本格導入します。

## 📋 導入手順

### Step 1: データベース関数デプロイ
```bash
# Supabaseダッシュボードまたはコンソールで実行
# ファイル: prodmemo_All/統合分納関数v3.sql
```

### Step 2: 既存発注ページに統合ダッシュボード追加
```tsx
// 例: src/pages/PurchaseOrderDetail.tsx に追加
import { IntegrationTestDashboard } from '../components/IntegrationTestDashboard';

// コンポーネント内に追加
<IntegrationTestDashboard orderNo="PO250920003" />
```

### Step 3: 既存の分納機能を統合システムに切り替え
```tsx
// 例: DeliveryModal.tsx で useIntegratedInstallment を使用
import { useIntegratedInstallment } from '../hooks/useIntegratedInstallment';

const { createInstallment, validation, hasIssues } = useIntegratedInstallment({
  parentOrderId: order.id,
  onSuccess: () => close(),
});
```

## 🧪 テスト手順

### 1. 統合状況確認
1. PO250920003の発注詳細ページを開く
2. 統合テストダッシュボードで現在の問題を確認
3. "🔍 統合検証"ボタンで詳細チェック

### 2. 自動修復テスト
1. "🔧 自動修復"ボタンで既存データ修復
2. "🚀 フロント修復"ボタンでフロントエンド修復
3. 修復後の統合状況を確認

### 3. 新規分納テスト
1. 統合分納管理から新規分納作成
2. 商品情報を正しく入力
3. 分納と在庫移動が同時作成されることを確認

## 📊 監視・運用

### 自動監視機能
- **30秒間隔**: 統合状況の自動チェック
- **リアルタイム**: 問題検出時の即時通知
- **自動修復**: 軽微な問題の自動解決

### 手動確認ポイント
- 分納作成時の在庫移動確認
- 日次の統合状況レポート
- エラーログの定期確認

## 🚨 トラブルシューティング

### よくある問題
1. **在庫移動が作成されない**
   - 商品IDが正しいか確認
   - RLS権限を確認
   - v3関数が正常にデプロイされているか確認

2. **統合チェックでエラー**
   - データベース接続を確認
   - 関数の権限設定を確認

3. **修復が失敗する**
   - transaction_idの整合性を確認
   - 商品マスタの存在を確認

## 📈 効果測定

### 導入前後の比較指標
- **未連携率**: 75% → 0%目標
- **手動修正作業**: 削減
- **データ整合性**: 向上
- **運用効率**: 向上

## 🔄 今後の拡張

### Phase 2: 高度な機能
- 複数商品の一括処理
- 在庫不足時の自動アラート
- 発注明細からの自動商品取得
- 分納スケジュール管理

### Phase 3: AI連携
- 分納パターン学習
- 最適な分納提案
- 異常検知アラート

---

## ✅ 導入完了チェックリスト

- [ ] v3関数のデプロイ確認
- [ ] 権限設定の確認
- [ ] テストダッシュボードの動作確認
- [ ] 既存データの修復完了
- [ ] 新規分納の統合動作確認
- [ ] 監視システムの稼働確認
- [ ] ユーザートレーニング完了
- [ ] 運用手順書の整備

**🎉 すべて完了したら統合システム本格運用開始！**